---
title: è‡ªå‹•ç”¢å‡ºå‰ç«¯ API å‹æ…‹èˆ‡ TanStack Query æ–¹æ³•å¯¦ä¾‹ï¼ŒåŠ é€Ÿå‰ç«¯é–‹ç™¼
date: '2023-09-18'
tags: [javascript, react]
---

å‰å¾Œç«¯å½¼æ­¤ä¹‹é–“æºé€šï¼Œæœ€éº»ç…©çš„åœ°æ–¹å¤§æ¦‚å°±æ˜¯ API æ ¼å¼ã€æœ‰æ²’æœ‰å¯«æ–‡ä»¶ï¼Œæ–‡ä»¶æœ‰æ²’æœ‰å®šæœŸæ›´æ–°ç¶­è­·ä¹‹é¡çš„ï¼Œå¾Œç«¯å¯ä»¥å¦¥å–„é‹ç”¨ Swagger ç”¢å‡ºæ–‡ä»¶ï¼Œå‰ç«¯åªè¦ä¾ç…§ Swagger æ–‡ä»¶å°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰åƒæ•¸èˆ‡å›å‚³å‹æ…‹ã€‚

æ—¢ç„¶å¾Œç«¯å¯ä»¥é€é Swagger è‡ªå‹•ç”¢æ–‡ä»¶ï¼Œå‰ç«¯æƒ³å¿…ä¹Ÿä¸€å®šå¯ä»¥é€éæŸäº›æ–¹å¼æ‹¿åˆ° Swagger çš„æ–‡ä»¶æ ¼å¼ï¼Œç„¶å¾Œè‡ªå‹•ç”¢å‡ºæ‰€æœ‰å‹æ…‹å•¦ï½ wwwww

æœ‰å¾ˆå¤šç›¸é—œå¥—ä»¶å¯ä»¥æŠ“åˆ°å‹æ…‹ï¼Œä½†æˆ‘é€™æ¬¡æƒ³ä»‹ç´¹ä½¿ç”¨çš„æ˜¯ [Orval](https://orval.dev) ï¼Œå¯ä»¥æ”¯æ´ OpenAPI v3 æˆ–æ˜¯ Swagger v2 ç‰ˆæœ¬çš„ `yaml` æˆ–æ˜¯ `json` æ ¼å¼ï¼Œå¯ä»¥è‡ªå‹•ç”¢å‡ºå¸¸ä½¿ç”¨åˆ°çš„ axios æˆ–æ˜¯ TanStack Query (React Query)ï¼Œä¸éœ€è¦å†çœ‹è‘—æ–‡ä»¶ä¸€å€‹ä¸€å€‹å¯« APIã€‚

ä½œè€…æœ¬èº«å°±æ˜¯å› ç‚ºç¶“å¸¸ä½¿ç”¨åˆ° Swagger editor è·Ÿ Swagger codegen ï¼Œä½†è¦ºå¾—ä¸å¤ å¥½ç”¨æ‰€ä»¥æ‰è‡ªå·±é–‹ç™¼é€™å€‹å¥—ä»¶ï¼Œå› ç‚ºä½œè€…è‡ªå·±æœƒç”¨åˆ°è¡¨ç¤ºé€™å€‹å¥—ä»¶æ‡‰è©²æœƒä¸€ç›´æ›´æ–°ä¸‹å»ï¼ˆï¼Ÿï¼‰

åœ¨é–‹ç™¼æ–‡ä»¶ä¸Šä¹Ÿæä¾›äº†è©³ç´°çš„å®˜æ–¹æ–‡æª”èˆ‡ Examplesã€‚

<img src="/images/posts/orval-01.png" alt="swagger example">

é¦–å…ˆèº«ç‚ºå‰ç«¯çš„ä½ ï¼Œå¿…é ˆè¦æ‹¿åˆ° `swagger.json` æˆ–æ˜¯ `yaml` æª”æ¡ˆï¼Œç¶²å€ä¹Ÿå¯ä»¥ï¼Œæˆ‘å€‘æœƒä½¿ç”¨é€™å…©å€‹ä»»ä¸€æª”æ¡ˆé€é Orval ç”¢å‡ºéœ€è¦çš„æ±è¥¿ã€‚

### 1. å®‰è£

```bash
$ npm i orval -D
  or
$ yarn add orval -D
```

### 2. åœ¨ package.json å¯«å…¥è…³æœ¬

```json
"scripts": {
    // ... others scripts

    "orval": "orval"
  },
```

### 3. åœ¨å°ˆæ¡ˆçš„æ ¹ç›®éŒ„æ–°å¢ä¸€å€‹ `orval.config.ts` çš„æª”æ¡ˆ

æ‹¿å‡ºæº–å‚™å¥½çš„ `swagger.json` æˆ‘å€‘è¦é–‹å§‹è‡ªå‹•ç”¢ç”Ÿ API client å›‰ï¼

`orval.config.ts` ç‚º Orval çš„è¨­å®šæª”ï¼Œå¯ä»¥å®¢è£½åŒ– axios èˆ‡ä½¿ç”¨ TanStack Queryï¼Œè¨­å®šæª”å…§å®¹å¯åƒè€ƒå®˜æ–¹æ–‡ä»¶ [https://orval.dev](https://orval.dev) ã€‚

```ts
// orval.config.ts
import { defineConfig } from 'orval'

export default defineConfig({
  api: {
    output: {
      mode: 'split',
      target: 'src/apis/endpoints.ts',
      // schemas: 'src/apis/models',   // é–‹å•Ÿæ­¤é¸é … endpoints.schemas.ts æœƒæ‹†æˆå¤šå€‹æª”æ¡ˆã€‚
      client: 'react-query',
      prettier: true,
      override: {
        // è¨­å®šè‡ªå®šç¾©çš„ API client æª”æ¡ˆä½ç½®
        mutator: {
          path: 'src/apis/custom-client.ts',
          name: 'useCustomInstance',
        },
        // è¨­å®š react-query çš„åƒæ•¸
        query: {
          useQuery: true,
          useInfinite: true,
          options: {
            staleTime: 10000,
          },
        },
      },
    },
    // è¨­å®š swagger.json çš„ä½ç½® (å¿…å¡«)
    input: {
      target: 'http://ä½ çš„ç¶²å€/swagger.json', // ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æª”æ¡ˆä½ç½®
    },
  },
})
```

### 4. è¨­å®šå®¢è£½åŒ–çš„ axios å¯¦ä¾‹

```ts
// custom-client.ts
import Axios, { AxiosRequestConfig } from 'axios'
import getToken from '@/utils/getToken'

export const AXIOS_INSTANCE = Axios.create({ baseURL: `${import.meta.env.VITE_API_URL}` }) // vite æ‹¿ env çš„ç”¨æ³•

export const useCustomInstance = <T>(): ((config: AxiosRequestConfig) => Promise<T>) => {
  return (config: AxiosRequestConfig) => {
    const source = Axios.CancelToken.source()
    const token = (Axios.AxiosHeaders = getToken())
    const promise = AXIOS_INSTANCE({
      ...config,
      cancelToken: source.token,
      headers: { ...config.headers, Authorization: `${token}` },
    }).then(({ data }) => {
      // é€™è£¡å¯ä»¥è‡ªå®šç¾©å›å‚³æ ¼å¼
      return data.data
    })

    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    promise.cancel = () => {
      source.cancel('Query was cancelled by React Query')
    }

    return promise
  }
}

export default useCustomInstance

// å®šç¾©ä½ çš„ ErrorType èˆ‡ BodyType
export type ErrorType<ErrorData> = ErrorData

export type BodyType<BodyData> = BodyData & {
  headers?: any
  data?: { token?: string; results?: any; data?: any; userInfo?: any }
  code?: number
  message?: string
}
```

### 5. ç”¢ç”Ÿæª”æ¡ˆ

æœ€å¾Œåœ¨çµ‚ç«¯æ©Ÿè¼¸å…¥ `yarn orval` å°±æœƒè‡ªå‹•ç”¢ç”Ÿ `endpoints.ts` èˆ‡ `endpoints.schemas.ts` å…©å€‹æª”æ¡ˆï¼Œä¸è¦æ‰‹å‹•ä¿®æ”¹é€™å…©å€‹æª”æ¡ˆï¼Œæ¯æ¬¡éƒ½é€é `yarn orval` æŒ‡ä»¤ä¾†æ›´æ–°é€™å…©å€‹æª”æ¡ˆã€‚

### endpoints.ts

è‡ªå‹•ç”¢ç”Ÿ API client èˆ‡ react-query ç‰ˆæœ¬ï¼Œåç¨±ä¹Ÿæœƒå¹«ä½ å–å¥½ï¼Œè¨»è§£ä¹Ÿæœƒä¸€èµ·å¯«é€²ä¾†ï¼ŒçœŸå¿ƒæ–¹ä¾¿(=Â´âˆ€ ï½€)äºº(Â´âˆ€ ï½€=)ã€‚

```ts
// endpoints.ts

/**
 * Generated by orval v6.17.0 ğŸº
 * Do not edit manually.
 * Swagger Petstore
 * OpenAPI spec version: 1.0.0
 */
import { useQuery, useMutation } from 'react-query'
import type {
  UseQueryOptions,
  UseMutationOptions,
  QueryFunction,
  MutationFunction,
  UseQueryResult,
  QueryKey,
} from 'react-query'
import type { Pets, Error, ListPetsParams, Pet, CreatePetsBody } from '../model'
import { useCustomClient } from '../mutator/custom-client'
import type { ErrorType, BodyType } from '../mutator/custom-client'

type AwaitedInput<T> = PromiseLike<T> | T

type Awaited<O> = O extends AwaitedInput<infer T> ? T : never

/**
 * @summary List all pets
 */
export const useListPetsHook = () => {
  const listPets = useCustomClient<Pets>()

  return (params?: ListPetsParams, version = 1, signal?: AbortSignal) => {
    return listPets({
      url: `/v${version}/pets`,
      method: 'get',
      params,
      signal,
    })
  }
}

export const getListPetsQueryKey = (params?: ListPetsParams, version = 1) => {
  return [`/v${version}/pets`, ...(params ? [params] : [])] as const
}

export const useListPetsQueryOptions = <
  TData = Awaited<ReturnType<ReturnType<typeof useListPetsHook>>>,
  TError = ErrorType<Error>
>(
  params?: ListPetsParams,
  version = 1,
  options?: {
    query?: UseQueryOptions<Awaited<ReturnType<ReturnType<typeof useListPetsHook>>>, TError, TData>
  }
): UseQueryOptions<Awaited<ReturnType<ReturnType<typeof useListPetsHook>>>, TError, TData> & { queryKey: QueryKey } => {
  const { query: queryOptions } = options ?? {}

  const queryKey = queryOptions?.queryKey ?? getListPetsQueryKey(params, version)

  const listPets = useListPetsHook()

  const queryFn: QueryFunction<Awaited<ReturnType<ReturnType<typeof useListPetsHook>>>> = ({ signal }) =>
    listPets(params, version, signal)

  return { queryKey, queryFn, enabled: !!version, ...queryOptions }
}

export type ListPetsQueryResult = NonNullable<Awaited<ReturnType<ReturnType<typeof useListPetsHook>>>>
export type ListPetsQueryError = ErrorType<Error>

// ...ä»¥ä¸‹çœç•¥
```

### endpoints.schemas.ts

é€™å€‹æª”æ¡ˆæœƒè‡ªå‹•ç”¢ç”Ÿ API çš„ TypeScriptï¼Œç›´æ¥ä½¿ç”¨è©²æª”æ¡ˆå…§ export çš„å…§å®¹å³å¯ã€‚
ä¹Ÿå¯ä»¥åŠ å…¥ msw æˆ–æ˜¯ faker ä½¿ç”¨å”·ï¼Œå› ç‚ºæˆ‘é€™é‚Šæ²’ç”¨åˆ°æ‰€ä»¥æ–¹æ³•è«‹åƒè€ƒ[å®˜æ–¹èªªæ˜æ–‡ä»¶](https://orval.dev/guides/basics)ã€‚

### ä½¿ç”¨æ–¹å¼

å› ç‚º Orval åªå®‰è£åœ¨é–‹ç™¼ç’°å¢ƒä¸Šï¼Œæ‰€ä»¥ä»–åªæ˜¯è¼”åŠ©ç”¢å‡ºæª”æ¡ˆï¼Œä½¿ç”¨æ–¹å¼å°±è·Ÿä»¥å‰å¯« axios æˆ–æ˜¯ TanStack Query éƒ½ä¸€æ¨£ã€‚

```tsx
// App.tsx
import React, { useEffect } from 'react'
import { useListPets } from './apis/endpoints.ts'
import { useAuthDispatch } from './auth.context'
import './App.css'

function App() {
  const dispatch = useAuthDispatch()
  const { data: pets, refetch } = useListPets() // ç›´æ¥ä½¿ç”¨

  useEffect(() => {
    dispatch('token')
    setTimeout(() => {
      refetch()
    }, 2000)
  }, [refetch, dispatch])

  return (
    <div className="App">
      <header className="App-header">
        {pets?.map((pet: any) => (
          <p key={pet.id}>{pet.name}</p>
        ))}
      </header>
    </div>
  )
}
```

ä»¥å¾Œåªè¦ API æ–‡ä»¶æœ‰æ›´æ–°ï¼Œåªè¦å†è·‘ä¸€é `yarn orval` æˆ–æ˜¯ç›´æ¥å¯«å…¥ä½ çš„åŸ·è¡Œçš„ dev è…³æœ¬å…§ï¼Œæ¯æ¬¡é–‹ç™¼æ™‚å°±æœƒè‡ªå·±æŠ“æœ€æ–° API æ–‡ä»¶ç”¢å‡ºæ ¼å¼äº†ï¼Œæ˜¯ä¸æ˜¯çœŸçš„å¥½æ–¹ä¾¿ï½ï½ï¼ˆæ’’èŠ±

å–œæ­¡é€™ç¯‡æ–‡ç« å°±è®“æˆ‘å€‘ä¸€èµ·åŠ å…¥å‰ç«¯æ‡¶äººè¡Œåˆ—å§ï½ï½(\ \*â‰§Ï‰â‰¦)
